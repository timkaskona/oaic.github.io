<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ ‚Äî –±—Ä–µ–Ω–¥–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (—Ñ–∏–∫—Å —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏—è)</title>
  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: —á—Ç–µ–Ω–∏–µ Excel –∏ –≥—Ä–∞—Ñ–∏–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    :root {
      /* –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ç–æ—á–Ω—ã–µ HEX –∏–∑ –±—Ä–µ–Ω–¥–±—É–∫–∞: */
      --brand-primary: #08b7be;
      --brand-primary-600: #0fa4a9;
      --brand-primary-100: #e6f7f8;
      --brand-accent-yellow: #ffd861;
      --ink-900: #15333a;
      --ink-600: #46646b;
      --surface: #ffffff;
      --border: #e8eef0;
      --success: #14b08a;
      --danger: #e04355;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font: 14px/1.35 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink-900); background: linear-gradient(180deg, var(--brand-primary-100), #f9fbfc);
    }

    .wrap { max-width: 1280px; margin: 20px auto; padding: 0 16px; display: grid; gap: 12px; }

    header {
      display:flex; align-items:center; justify-content: space-between; gap:12px;
      background: var(--surface); border:1px solid var(--border); border-radius: 16px; padding: 12px 14px;
    }
    .brand { display:flex; align-items:center; gap:12px; }
    .brand-logo {
      width:36px; height:36px; border-radius:50%; background: var(--brand-primary);
      box-shadow: inset 12px -8px 0 0 rgba(255,216,97,.25), inset -10px 12px 0 0 rgba(8,183,190,.35);
    }
    h1 { font-size: 18px; margin:0; }
    .sub { color: var(--ink-600); font-size: 12px; }

    .controls { display:flex; flex-wrap: wrap; gap: 8px; align-items:center; }
    .btn { cursor:pointer; appearance:none; border: none; padding:8px 12px; border-radius: 10px; font-weight:600; }
    .btn-primary { background: var(--brand-primary); color:#fff; }

    .select, select { appearance:none; padding:8px 12px; border-radius: 10px; border:1px solid var(--border); background:#fff; color:inherit; }
    .segmented { display:flex; background:#fff; border:1px solid var(--border); border-radius: 12px; overflow:hidden; }
    .segmented button { padding:8px 10px; border:0; background:#fff; color:var(--ink-600); cursor:pointer; }
    .segmented button.active { background: var(--brand-primary-100); color: var(--ink-900); font-weight:600; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ KPI */
    .kpi-grid { display:grid; grid-template-columns: repeat(5, minmax(160px, 1fr)); gap: 10px; }
    .card { background: var(--surface); border:1px solid var(--border); border-radius: 16px; padding: 12px; overflow: hidden; }
    .kpi .label { font-size: 12px; color: var(--ink-600); margin-bottom: 6px; }
    .kpi .value { font-size: 28px; font-weight: 800; letter-spacing: -0.02em; }
    .kpi .muted { color: var(--ink-600); font-size: 12px; }
    .delta { font-weight: 700; }
    .delta.up { color: var(--success); }
    .delta.down { color: var(--danger); }

    /* –ì–ª–∞–≤–Ω—ã–π –≥—Ä–∏–¥ */
    .grid { display:grid; grid-template-columns: 1.4fr .9fr; gap: 10px; }
    .panel h3 { margin: 0 0 8px; font-size: 14px; }
    .panel .row { display:flex; gap: 8px; align-items:center; }

    /* –í–ê–ñ–ù–û: —Ñ–∏–∫—Å —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤—ã—Å–æ—Ç—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤ */
    .panel .chart { position: relative; height: 320px; }
    @media (min-width: 1200px){ .panel .chart { height: 360px; } }
    .panel canvas { display:block; width:100% !important; height:100% !important; }

    .table-wrap { height: 360px; overflow:auto; border:1px solid var(--border); border-radius: 12px; }
    table { width:100%; border-collapse: collapse; font-size: 12px; }
    thead th { position: sticky; top:0; background:#fff; z-index:2; text-align:left; padding:10px; border-bottom:1px solid var(--border); }
    tbody td { padding:8px 10px; border-bottom:1px solid #f1f4f6; }

    .hint { font-size: 12px; color: var(--ink-600); }

    /* –î–µ–∫–æ—Ä */
    .dots { position: absolute; inset: -30px auto auto -30px; width: 120px; height: 120px; border-radius: 50%;
      background: radial-gradient(ellipse at 30% 30%, rgba(255,216,97,.6) 0 30%, rgba(8,183,190,.75) 31% 60%, rgba(255,255,255,0) 61% 100%);
      filter: blur(6px); opacity:.25; pointer-events:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <div>
          <h1>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥</h1>
          <div class="sub">–ó–∞–≥—Ä—É–∑–∫–∞ Excel —Å –ø–ª–∞–Ω–æ–º/—Ñ–∞–∫—Ç–æ–º ‚Ä¢ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –º–µ—Å—è—Ü—É/–≥–æ–¥—É ‚Ä¢ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ: –∫ –ø–ª–∞–Ω—É / –∫ –ø—Ä–æ—à–ª–æ–º—É –≥–æ–¥—É / –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–≤–∞—Ä—Ç–∞–ª—É</div>
        </div>
      </div>
      <div class="controls">
        <label class="btn btn-primary" for="fileInput">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls" hidden />

        <select id="yearSelect" title="–ì–æ–¥"></select>
        <select id="monthSelect" title="–ú–µ—Å—è—Ü"></select>

        <div class="segmented" role="tablist" aria-label="–ê–≥—Ä–µ–≥–∞—Ü–∏—è">
          <button id="agg-month" class="active" data-agg="month">–ú–µ—Å—è—Ü</button>
          <button id="agg-quarter" data-agg="quarter">–ö–≤–∞—Ä—Ç–∞–ª</button>
          <button id="agg-year" data-agg="year">–ì–æ–¥</button>
        </div>

        <select id="compareSelect" title="–°—Ä–∞–≤–Ω–µ–Ω–∏–µ">
          <option value="plan">–ö –ø–ª–∞–Ω—É</option>
          <option value="prev_year">–ö –ø—Ä–æ—à–ª–æ–º—É –≥–æ–¥—É</option>
          <option value="prev_quarter">–ö –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–≤–∞—Ä—Ç–∞–ª—É</option>
        </select>

        <select id="metricSelect" title="–ú–µ—Ç—Ä–∏–∫–∞">
          <option value="revenue">–í—ã—Ä—É—á–∫–∞</option>
          <option value="expenses">–†–∞—Å—Ö–æ–¥—ã (—Å–µ–±–µ—Å—Ç.+–∫–æ–º–º.)</option>
          <option value="cost">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</option>
          <option value="commercial">–ö–æ–º–º. —Ä–∞—Å—Ö–æ–¥—ã</option>
          <option value="profit">–ü—Ä–∏–±—ã–ª—å</option>
        </select>
      </div>
    </header>

    <!-- KPI -->
    <section class="kpi-grid">
      <div id="kpi-revenue" class="card kpi"></div>
      <div id="kpi-expenses" class="card kpi"></div>
      <div id="kpi-cost" class="card kpi"></div>
      <div id="kpi-commercial" class="card kpi"></div>
      <div id="kpi-profit" class="card kpi" style="position:relative; overflow:hidden;">
        <div class="dots"></div>
      </div>
    </section>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <section class="grid">
      <div class="panel card">
        <div class="row" style="justify-content: space-between; align-items:baseline;">
          <h3 id="trendTitle">–î–∏–Ω–∞–º–∏–∫–∞</h3>
          <span class="hint">–õ–ö–ú ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞, –ü–ö–ú/–¥–æ–ª–≥–æ–µ –∫–∞—Å–∞–Ω–∏–µ ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –≥—Ä–∞—Ñ–∏–∫–∞</span>
        </div>
        <div class="chart"><canvas id="trendChart"></canvas></div>
      </div>

      <div class="panel card">
        <h3 id="ratingTitle">–†–µ–π—Ç–∏–Ω–≥ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º</h3>
        <div class="chart"><canvas id="barChart"></canvas></div>
      </div>

      <div class="panel card">
        <h3>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
        <div class="chart"><canvas id="pieChart"></canvas></div>
      </div>

      <div class="panel card">
        <h3>–†–∞—Å—Ö–æ–¥—ã –ø–æ —Å—Ç–∞—Ç—å—è–º</h3>
        <div class="table-wrap">
          <table id="table">
            <thead>
              <tr>
                <th>–°—Ç–∞—Ç—å—è</th>
                <th style="text-align:right">–§–∞–∫—Ç</th>
                <th style="text-align:right">–ü–ª–∞–Ω</th>
                <th style="text-align:right">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script>
    // –ß–∞—Å—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ ¬´–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞¬ª —Å–≤—è–∑–∞–Ω–∞ —Å —Ü–∏–∫–ª–æ–º —Ä–µ—Å–∞–π–∑–æ–≤.
    // –ß—É—Ç—å ¬´–∑–∞–≥–ª—É—à–∏–º¬ª ResizeObserver Chart.js:
    if (window.Chart && Chart.defaults) { Chart.defaults.resizeDelay = 200; }

    // ======= –£—Ç–∏–ª–∏—Ç—ã
    const RU_MONTHS = ['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'];
    const money = n => (n/1000).toLocaleString('ru-RU'); // –≤ —Ç—ã—Å. —Ä—É–±
    const pct = v => (v>=0?'+':'') + (isFinite(v)? Math.round(v) : 0) + '%';

    const colsMap = {
      date: ['–¥–∞—Ç–∞','date'],
      project: ['–ø—Ä–æ–µ–∫—Ç','project'],
      category: ['—Å—Ç–∞—Ç—å—è','–∫–∞—Ç–µ–≥–æ—Ä–∏—è','category'],
      revenue: ['–≤—ã—Ä—É—á–∫–∞','revenue'],
      cost: ['—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å','cost'],
      commercial: ['–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã','–∫–æ–º–º. —Ä–∞—Å—Ö–æ–¥—ã','commercial']
    };
    const normKey = s => String(s||'').trim().toLowerCase();

    function mapRow(row){
      const mapped = { date:null, project:null, category:null, revenue:0, cost:0, commercial:0 };
      for (const [key, variants] of Object.entries(colsMap)){
        const col = Object.keys(row).find(k => variants.includes(normKey(k)) );
        if (col!==undefined){ mapped[key] = row[col]; }
      }
      // –î–∞—Ç–∞ –∏–∑ Excel (–¥–∞—Ç–∞/–Ω–æ–º–µ—Ä):
      let d = mapped.date;
      if (typeof d === 'number') { d = new Date((d - 25569) * 86400 * 1000); }
      else if (typeof d === 'string') { const t = Date.parse(d); d = isNaN(t) ? null : new Date(t); }
      mapped.date = d;
      mapped.project = mapped.project || '‚Äî';
      mapped.category = mapped.category || '‚Äî';
      // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —á–∏—Å–µ–ª: —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã (–≤–∫–ª—é—á–∞—è –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ) –∏ –º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É
      for (const k of ['revenue','cost','commercial']) {
        const raw = String(mapped[k] ?? '').replace(/\s+/g, '').replace(/,/g, '.');
        mapped[k] = Number(raw) || 0;
      }
      return mapped;
    }

    const getQuarter = m => Math.floor((m-1)/3) + 1; // month:1-12
    const prevQuarterOf = (year, q) => (q>1 ? {year, quarter:q-1} : {year:year-1, quarter:4});

    // ======= –°–æ—Å—Ç–æ—è–Ω–∏–µ
    let fact=[], plan=[]; // –º–∞—Å—Å–∏–≤—ã –æ–±—ä–µ–∫—Ç–æ–≤
    let selectedYear, selectedMonth = 0; // 0 => –≤—Å–µ –º–µ—Å—è—Ü—ã
    let aggregation = 'month';
    let compareMode = 'plan';
    let metric = 'revenue';

    // ======= –ö–æ–Ω—Ç—Ä–æ–ª—ã
    const $year = document.getElementById('yearSelect');
    const $month = document.getElementById('monthSelect');
    const $compare = document.getElementById('compareSelect');
    const $metric = document.getElementById('metricSelect');
    const $file = document.getElementById('fileInput');

    document.querySelectorAll('.segmented button').forEach(btn=>{
      btn.addEventListener('click', () => {
        document.querySelectorAll('.segmented button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        aggregation = btn.dataset.agg; renderAll();
      })
    })

    $year.onchange = () => { selectedYear = +$year.value; renderAll(); };
    $month.onchange = () => { selectedMonth = +$month.value; renderAll(); };
    $compare.onchange = () => { compareMode = $compare.value; renderAll(); };
    $metric.onchange = () => { metric = $metric.value; renderAll(); };

    $file.addEventListener('change', handleFile);

    function handleFile(e){
      const f = e.target.files?.[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        const wb = XLSX.read(new Uint8Array(evt.target.result), {type:'array'});

        const findSheet = (namePart) => wb.SheetNames.find(s => s.toLowerCase().includes(namePart));
        const sFact = wb.Sheets[ findSheet('—Ñ–∞–∫—Ç') || '–§–∞–∫—Ç' ] || wb.Sheets[wb.SheetNames[0]];
        const sPlan = wb.Sheets[ findSheet('–ø–ª–∞–Ω') || '–ü–ª–∞–Ω' ] || wb.Sheets[wb.SheetNames[1]] || wb.Sheets[wb.SheetNames[0]];

        const jFact = XLSX.utils.sheet_to_json(sFact).map(mapRow).filter(r=>r.date);
        const jPlan = XLSX.utils.sheet_to_json(sPlan).map(mapRow).filter(r=>r.date);

        fact = jFact.map(r=> ({...r, type:'fact', y:r.date.getFullYear(), m:r.date.getMonth()+1, q:getQuarter(r.date.getMonth()+1)}));
        plan = jPlan.map(r=> ({...r, type:'plan', y:r.date.getFullYear(), m:r.date.getMonth()+1, q:getQuarter(r.date.getMonth()+1)}));

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –≥–æ–¥–æ–≤/–º–µ—Å—è—Ü–µ–≤
        const years = Array.from(new Set(fact.map(r=>r.y).concat(plan.map(r=>r.y)))).sort((a,b)=>b-a);
        $year.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
        selectedYear = years[0];

        $month.innerHTML = `<option value="0">–í—Å–µ –º–µ—Å—è—Ü—ã</option>` + RU_MONTHS.map((m, i)=>`<option value="${i+1}">${m}</option>`).join('');
        selectedMonth = 0;

        renderAll();
      };
      reader.readAsArrayBuffer(f);
    }

    // ======= –†–∞—Å—á—ë—Ç—ã
    const sum = (arr, f) => arr.reduce((s,r)=> s + (f(r)||0), 0);
    const byMetric = r => metric==='expenses' ? (r.cost + r.commercial) : metric==='profit' ? (r.revenue - r.cost - r.commercial) : r[metric];

    function periodFilter(r){
      if (r.y !== selectedYear) return false;
      if (selectedMonth && r.m !== selectedMonth) return false;
      return true;
    }

    function kpis(){
      const fNow = fact.filter(periodFilter);
      const pNow = plan.filter(periodFilter);

      // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –∫ –ø–ª–∞–Ω—É / –∫ –ø—Ä–æ—à–ª–æ–º—É –≥–æ–¥—É / –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–≤–∞—Ä—Ç–∞–ª—É
      const currentYear = selectedYear;
      const prevYear = currentYear - 1;

      const fPrevYear = fact.filter(r=> r.y === prevYear && (!selectedMonth || r.m===selectedMonth));

      // –ü—Ä–µ–¥—ã–¥—É—â–∏–π –∫–≤–∞—Ä—Ç–∞–ª –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞ (–∏–ª–∏ Q4 –ø—Ä–æ—à–ª–æ–≥–æ –≥–æ–¥–∞, –µ—Å–ª–∏ ¬´–≤—Å–µ¬ª)
      let fPrevQuarter = [];
      if (selectedMonth) {
        const q = getQuarter(selectedMonth); const {year, quarter} = prevQuarterOf(currentYear, q);
        fPrevQuarter = fact.filter(r => r.y===year && r.q===quarter);
      } else {
        fPrevQuarter = fact.filter(r => r.y===prevYear && r.q===4);
      }

      function metricsFrom(rows){
        const revenue = sum(rows, r=>r.revenue);
        const cost = sum(rows, r=>r.cost);
        const commercial = sum(rows, r=>r.commercial);
        const expenses = cost + commercial;
        const profit = revenue - expenses;
        return { revenue, cost, commercial, expenses, profit };
      }

      const F = metricsFrom(fNow);
      const P = metricsFrom(pNow);
      const FY = metricsFrom(fPrevYear);
      const FQ = metricsFrom(fPrevQuarter);

      function rel(curr, base){ return base ? (curr-base)/base*100 : 0; }

      const compareBase = { plan: P, prev_year: FY, prev_quarter: FQ }[compareMode];

      const pack = (key, label) => ({
        label,
        value: F[key],
        delta: rel(F[key], (compareBase||{})[key] || 0)
      });

      return {
        revenue: pack('revenue','–í—ã—Ä—É—á–∫–∞, —Ç—ã—Å. —Ä—É–±'),
        expenses: pack('expenses','–†–∞—Å—Ö–æ–¥—ã, —Ç—ã—Å. —Ä—É–±'),
        cost: pack('cost','–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, —Ç—ã—Å. —Ä—É–±'),
        commercial: pack('commercial','–ö–æ–º–º. —Ä–∞—Å—Ö–æ–¥—ã, —Ç—ã—Å. —Ä—É–±'),
        profit: pack('profit','–ü—Ä–∏–±—ã–ª—å, —Ç—ã—Å. —Ä—É–±')
      }
    }

    // ======= –†–µ–Ω–¥–µ—Ä—ã
    let trendChart, barChart, pieChart;

    function renderKPIs(){
      const K = kpis();
      const cfg = [
        ['revenue', 'kpi-revenue'],
        ['expenses','kpi-expenses'],
        ['cost','kpi-cost'],
        ['commercial','kpi-commercial'],
        ['profit','kpi-profit']
      ];

      for (const [key, id] of cfg){
        const k = K[key];
        const up = k.delta >= 0;
        document.getElementById(id).innerHTML = `
          <div class="label">${k.label}</div>
          <div class="value">${money(k.value)}</div>
          <div class="muted">${compareLabel()} <span class="delta ${up?'up':'down'}">${pct(k.delta)}</span></div>
        `;
      }
    }

    function compareLabel(){
      return { plan: '–∫ –ø–ª–∞–Ω—É', prev_year: '–∫ –ø—Ä–æ—à–ª–æ–º—É –≥–æ–¥—É', prev_quarter: '–∫ –ø—Ä–µ–¥. –∫–≤–∞—Ä—Ç–∞–ª—É' }[compareMode];
    }

    function renderTrend(){
      const ctx = document.getElementById('trendChart').getContext('2d');
      if (trendChart) trendChart.destroy();

      document.getElementById('trendTitle').textContent = `–î–∏–Ω–∞–º–∏–∫–∞ ${labelFor(metric)} (${aggregation==='month'?'–ø–æ –º–µ—Å—è—Ü–∞–º':aggregation==='quarter'?'–ø–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º':'–∑–∞ –≥–æ–¥'}), —Ç—ã—Å. —Ä—É–±`;

      const points = [];
      if (aggregation==='quarter'){
        for (let q=1;q<=4;q++){
          const filt = r=> r.y===selectedYear && r.q===q && (!selectedMonth || true);
          const fVal = sum(fact.filter(filt), byMetric);
          const pVal = sum(plan.filter(filt), byMetric);
          const yVal = sum(fact.filter(r=> r.y===selectedYear-1 && r.q===q), byMetric);
          points.push({label: 'Q'+q, f:fVal, p:pVal, y:yVal});
        }
      } else if (aggregation==='year'){
        const fVal = sum(fact.filter(r=> r.y===selectedYear), byMetric);
        const pVal = sum(plan.filter(r=> r.y===selectedYear), byMetric);
        const yVal = sum(fact.filter(r=> r.y===selectedYear-1), byMetric);
        points.push({label: String(selectedYear), f:fVal, p:pVal, y:yVal});
      } else {
        for (let m=1;m<=12;m++){
          if (selectedMonth && m!==selectedMonth) continue;
          const fVal = sum(fact.filter(r=> r.y===selectedYear && r.m===m), byMetric);
          const pVal = sum(plan.filter(r=> r.y===selectedYear && r.m===m), byMetric);
          const yVal = sum(fact.filter(r=> r.y===selectedYear-1 && r.m===m), byMetric);
          points.push({label: RU_MONTHS[m-1], f:fVal, p:pVal, y:yVal});
        }
      }

      const palette = {
        fact: getComputedStyle(document.documentElement).getPropertyValue('--brand-primary').trim(),
        plan: 'rgba(15,164,169,.45)',
        prev: '#b6c5c9'
      };

      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: points.map(p=>p.label),
          datasets: [
            { label: '–§–∞–∫—Ç', data: points.map(p=>p.f/1000), borderColor: palette.fact, backgroundColor:'transparent', tension:.35, borderWidth:3, pointRadius:4 },
            { label: '–ü–ª–∞–Ω', data: points.map(p=>p.p/1000), borderColor: palette.plan, backgroundColor:'transparent', tension:.35, borderDash:[4,4], borderWidth:2, pointRadius:3 },
            { label: '–§–∞–∫—Ç –ø—Ä–æ—à–ª–æ–≥–æ –≥–æ–¥–∞', data: points.map(p=>p.y/1000), borderColor: palette.prev, backgroundColor:'transparent', tension:.35, borderWidth:2, pointRadius:3 }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false, resizeDelay:200,
          interaction:{ mode:'index', intersect:false },
          plugins: {
            legend: { position:'top', labels:{ usePointStyle:true } },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${money(ctx.parsed.y*1000)}` } }
          },
          scales: {
            y: { display:false, beginAtZero:true },
            x: { ticks:{ maxRotation:0, autoSkipPadding:24 } }
          }
        }
      });
    }

    function renderBars(){
      const ctx = document.getElementById('barChart').getContext('2d');
      if (barChart) barChart.destroy();

      const filt = r=> r.y===selectedYear && (!selectedMonth || r.m===selectedMonth);
      const rows = fact.filter(filt);
      const projects = [...new Set(rows.map(r=>r.project))];
      const data = projects.map(p=> ({
        label:p,
        value: sum(rows.filter(r=>r.project===p), byMetric)
      })).sort((a,b)=>b.value-a.value).slice(0,12);

      document.getElementById('ratingTitle').textContent = `${labelFor(metric)} –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º, —Ç—ã—Å. —Ä—É–±`;

      const color = getComputedStyle(document.documentElement).getPropertyValue('--brand-primary').trim();

      barChart = new Chart(ctx, {
        type:'bar',
        data: { labels: data.map(d=>d.label), datasets:[{ label:'', data: data.map(d=>d.value/1000), backgroundColor: color+'cc', borderColor: color, borderWidth:1, borderRadius:6 }] },
        options: {
          indexAxis:'y', responsive:true, maintainAspectRatio:false, resizeDelay:200,
          plugins: { legend:{display:false}, tooltip:{ callbacks:{ label: ctx => money(ctx.parsed.x*1000) } } },
          scales: { x:{ display:false, beginAtZero:true }, y:{ ticks:{ autoSkip:false } } }
        }
      });
    }

    function renderPie(){
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      const filt = r=> r.y===selectedYear && (!selectedMonth || r.m===selectedMonth);
      const rows = fact.filter(filt);

      const byCat = {};
      for (const r of rows){ const v = r.cost + r.commercial; byCat[r.category] = (byCat[r.category]||0)+v; }
      const entries = Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,10);

      const labels = entries.map(e=>e[0]);
      const values = entries.map(e=>e[1]/1000);

      const base = getComputedStyle(document.documentElement).getPropertyValue('--brand-primary').trim();
      const acc = getComputedStyle(document.documentElement).getPropertyValue('--brand-accent-yellow').trim();
      const colors = values.map((_,i)=> i%3===0?acc+'cc': base + (i%2? 'cc': '99'));

      pieChart = new Chart(ctx, {
        type:'doughnut',
        data:{ labels, datasets:[{ data:values, backgroundColor:colors, borderWidth:0 }]},
        options:{
          responsive:true, maintainAspectRatio:false, resizeDelay:200,
          plugins:{ legend:{ position:'right' }, tooltip:{ callbacks:{ label:ctx=> `${ctx.label}: ${money(ctx.parsed*1000)}` }}}
        }
      });
    }

    function renderTable(){
      const body = document.querySelector('#table tbody');
      const filt = r=> r.y===selectedYear && (!selectedMonth || r.m===selectedMonth);
      const fRows = fact.filter(filt), pRows = plan.filter(filt);

      const fBy = {}, pBy = {};
      for (const r of fRows){ const v = r.cost + r.commercial; fBy[r.category] = (fBy[r.category]||0)+v; }
      for (const r of pRows){ const v = r.cost + r.commercial; pBy[r.category] = (pBy[r.category]||0)+v; }

      const cats = new Set([...Object.keys(fBy), ...Object.keys(pBy)]);
      const rows = [...cats].map(c=> ({ c, f:fBy[c]||0, p:pBy[c]||0, e: (pBy[c]? (fBy[c]-pBy[c])/pBy[c]*100 : 0) })).sort((a,b)=>b.f-a.f).slice(0,30);

      body.innerHTML = rows.map(r=> `
        <tr>
          <td>${r.c}</td>
          <td style="text-align:right">${money(r.f)}</td>
          <td style="text-align:right">${money(r.p)}</td>
          <td style="text-align:right; font-weight:700; color:${r.e>=0? 'var(--success)':'var(--danger)'}">${pct(r.e)}</td>
        </tr>`).join('');
    }

    function renderAll(){
      if (!fact.length) return; // –∂–¥—ë–º —Ñ–∞–π–ª
      renderKPIs();
      renderTrend();
      renderBars();
      renderPie();
      renderTable();
    }

    function labelFor(k){
      return ({
        revenue:'–í—ã—Ä—É—á–∫–∞',
        expenses:'–†–∞—Å—Ö–æ–¥—ã',
        cost:'–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å',
        commercial:'–ö–æ–º–º. —Ä–∞—Å—Ö–æ–¥—ã',
        profit:'–ü—Ä–∏–±—ã–ª—å'
      })[k];
    }
  </script>
</body>
</html>
